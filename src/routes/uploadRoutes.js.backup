import express from 'express';
import upload from '../middlewares/uploadMiddleware.js';
import { protect } from '../middlewares/authMiddleware.js';
import {
  uploadProfileImage,
  uploadTutorCertificates,
  uploadTutorDocuments,
  getTutorDocuments,
  deleteCertificate,
  deleteDocument,
  getTutorDocumentsAdmin
} from '../controllers/uploadController.js';

const router = express.Router();

/* =========================
   TEST ROUTE (No Auth)
========================= */
router.get('/test', (req, res) => {
  res.json({
    success: true,
    message: 'Upload API is working!',
    timestamp: new Date().toISOString(),
    endpoints: {
      profile: 'POST /api/upload/profile (Auth required)',
      certificates: 'POST /api/upload/tutor/certificates (Auth required)',
      documents: 'POST /api/upload/tutor/documents (Auth required)',
      getDocuments: 'GET /api/upload/tutor/documents (Auth required)'
    }
  });
});

/* =========================
   SIMPLE UPLOAD (FOR TESTING)
========================= */
router.post(
  '/simple',
  upload.single('file'),
  async (req, res) => {
    try {
      console.log('��� Simple upload received');
      
      if (!req.file) {
        return res.status(400).json({
          success: false,
          message: 'No file uploaded'
        });
      }

      const fileUrl = `/uploads/documents/${req.file.filename}`;
      
      res.status(200).json({
        success: true,
        message: 'File uploaded successfully',
        data: {
          filename: req.file.filename,
          url: fileUrl,
          originalname: req.file.originalname,
          mimetype: req.file.mimetype,
          size: req.file.size,
          path: req.file.path
        }
      });
    } catch (error) {
      console.error('Upload error:', error);
      res.status(500).json({
        success: false,
        message: 'Error uploading file',
        error: error.message
      });
    }
  }
);

/* =========================
   PROFILE IMAGE UPLOAD
========================= */
router.post(
  '/profile',
  protect,
  upload.single('profileImage'),
  uploadProfileImage
);

/* =========================
   TUTOR CERTIFICATES UPLOAD
========================= */
router.post(
  '/tutor/certificates',
  protect,
  upload.array('certificateFiles', 5), // Max 5 files
  uploadTutorCertificates
);

/* =========================
   TUTOR VERIFICATION DOCUMENTS
========================= */
router.post(
  '/tutor/documents',
  protect,
  upload.array('documentFiles', 10), // Max 10 files
  uploadTutorDocuments
);

/* =========================
   GET TUTOR DOCUMENTS
========================= */
router.get(
  '/tutor/documents',
  protect,
  getTutorDocuments
);

/* =========================
   DELETE CERTIFICATE
========================= */
router.delete(
  '/tutor/certificates/:certId',
  protect,
  deleteCertificate
);

/* =========================
   DELETE DOCUMENT
========================= */
router.delete(
  '/tutor/documents/:docId',
  protect,
  deleteDocument
);

/* =========================
   ADMIN: VIEW TUTOR DOCUMENTS
========================= */
router.get(
  '/admin/tutors/:tutorId/documents',
  protect,
  getTutorDocumentsAdmin
);

/* =========================
   MULTIPLE FILES UPLOAD
========================= */
router.post(
  '/multiple',
  upload.array('files', 5),
  async (req, res) => {
    try {
      if (!req.files || req.files.length === 0) {
        return res.status(400).json({
          success: false,
          message: 'No files uploaded'
        });
      }

      const uploadedFiles = req.files.map(file => ({
        filename: file.filename,
        url: `/uploads/documents/${file.filename}`,
        originalname: file.originalname,
        mimetype: file.mimetype,
        size: file.size
      }));

      res.status(200).json({
        success: true,
        message: `${req.files.length} file(s) uploaded successfully`,
        files: uploadedFiles
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        message: 'Error uploading files',
        error: error.message
      });
    }
  }
);

/* =========================
   FILE INFO ENDPOINT
========================= */
router.get('/info', (req, res) => {
  res.json({
    success: true,
    limits: {
      maxFileSize: '5MB',
      allowedTypes: ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'],
      maxFiles: {
        certificates: 5,
        documents: 10,
        multiple: 5
      }
    },
    endpoints: {
      test: 'GET /api/upload/test',
      simple: 'POST /api/upload/simple',
      multiple: 'POST /api/upload/multiple',
      profile: 'POST /api/upload/profile',
      tutorCertificates: 'POST /api/upload/tutor/certificates',
      tutorDocuments: 'POST /api/upload/tutor/documents',
      getTutorDocuments: 'GET /api/upload/tutor/documents'
    }
  });
});

export default router;
